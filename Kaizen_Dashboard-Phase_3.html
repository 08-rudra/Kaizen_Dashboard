<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaizen Management Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #667eea; --secondary: #764ba2; --success: #28a745; --warning: #ffc107; --danger: #dc3545; --info: #17a2b8; --light: #f8f9fa; --dark: #343a40; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header h1 { font-size: 2.5em; background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .centered-title { text-align: center; width: 100%; font-size: 1.5em; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 14px; }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .filters-section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .filter-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .filter-group select, .filter-group input, .modal-form textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; }
        .filter-group select:focus, .filter-group input:focus, .modal-form textarea:focus { outline: none; border-color: var(--primary); }
        .filter-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .search-box { width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 16px; margin-bottom: 20px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .metric-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; }
        .metric-card:hover { transform: translateY(-5px); }
        .metric-value { font-size: 3em; font-weight: bold; background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .metric-label { font-size: 1.1em; color: #666; margin-top: 10px; }
        .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .chart-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .chart-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; color: #333; }
        .chart-container { height: 300px; position: relative; }
        .table-section { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; text-align: left; vertical-align: middle;}
        th:first-child, td:first-child { width: 20px; text-align: center; }
        tr:hover { background: #f8f9fa; }
        th { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; font-weight: 600; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-implemented { background: #d4edda; color: #155724; }
        .status-progress { background: #fff3cd; color: #856404; }
        .benefit-badge { padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; }
        .benefit-productivity { background: #cce5ff; color: #004085; }
        .benefit-quality { background: #f8d7da; color: #721c24; }
        .benefit-both { background: #d1ecf1; color: #0c5460; }
        .action-btn { padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; background: white; cursor: pointer; margin: 2px; font-size: 12px; }
        .action-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-footer { margin-top: 25px; text-align: right; }
        .close { font-size: 30px; cursor: pointer; color: #999; }
        .close:hover { color: var(--danger); }
        .modal-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .modal-form .full-width { grid-column: 1 / -1; }
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 10px 0; }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .pagination-btn { background-color: white; border: 1px solid #ccc; border-radius: 5px; padding: 8px 12px; cursor: pointer; font-weight: 600; }
        .pagination-btn:hover { background-color: #f0f0f0; }
        .pagination-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        .pagination-btn:disabled { cursor: not-allowed; color: #aaa; }
        .rows-per-page-selector label { font-weight: 600; margin-right: 10px; }
        .rows-per-page-selector select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        @media (max-width: 768px) { .charts-section, .filters-grid, .modal-form { grid-template-columns: 1fr; } .header { justify-content: center; text-align: center; } .header h1 { font-size: 1.8em; width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üöÄ Kaizen Management Dashboard</h1>
                <h2 class="centered-title" style="font-size:1.5em;">Sky Source</h2>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openAddModal()">‚ûï New Kaizen</button>
                <button class="btn btn-info" onclick="triggerImport()">üì• Import Excel</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export Excel</button>
                <button class="btn btn-warning" onclick="exportToPDF()">üìÑ Export PDF</button>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print</button>
            </div>
        </div>

        <input type="file" id="importFile" style="display: none;" accept=".xlsx, .xls, .csv" onchange="handleFile(event)">

        <div class="filters-section">
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Search across all fields..." oninput="applyFilters()">
            <div class="filters-grid">
                <div class="filter-group"><label>üìÖ Year</label><select id="yearFilter" onchange="applyFilters()"><option value="all">All Years</option></select></div>
                <div class="filter-group"><label>üìÜ Month</label><select id="monthFilter" onchange="applyFilters()"><option value="all">All Months</option></select></div>
                <div class="filter-group"><label>‚ö° Status</label><select id="statusFilter" onchange="applyFilters()"><option value="all">All Status</option></select></div>
                <div class="filter-group"><label>üìã Project</label><select id="projectFilter" onchange="applyFilters()"><option value="all">All Projects</option></select></div>
                <div class="filter-group"><label>üë§ Employee</label><select id="employeeFilter" onchange="applyFilters()"><option value="all">All Employees</option></select></div>
                <div class="filter-group"><label>üéØ Benefit</label><select id="benefitFilter" onchange="applyFilters()"><option value="all">All Benefits</option></select></div>
                <div class="filter-group"><label>üè∑Ô∏è Kaizen Type</label><select id="typeFilter" onchange="applyFilters()"><option value="all">All Types</option></select></div>
                <div class="filter-group"><label>üìä Reporting</label><select id="reportingFilter" onchange="applyFilters()"><option value="all">All</option></select></div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">üîç Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">üîÑ Clear All</button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card"><div class="metric-value" id="totalKaizen">0</div><div class="metric-label">Total Kaizen</div></div>
            <div class="metric-card"><div class="metric-value" id="implementedCount">0</div><div class="metric-label">Implemented</div></div>
            <div class="metric-card"><div class="metric-value" id="inProgressCount">0</div><div class="metric-label">In Progress</div></div>
            <div class="metric-card"><div class="metric-value" id="successRate">0%</div><div class="metric-label">Success Rate</div></div>
        </div>

        <div class="charts-section">
            <div class="chart-card"><h3 class="chart-title">üìà Yearly Trend</h3><div class="chart-container"><canvas id="yearlyChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title">üìà Monthly Trend</h3><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title">üìä Status Distribution</h3><div class="chart-container"><canvas id="statusChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title">üéØ Benefit Analysis</h3><div class="chart-container"><canvas id="benefitChart"></canvas></div></div>
        </div>

        <div class="table-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 class="chart-title" style="margin: 0;">üìã Kaizen Records</h3>
                <button id="deleteSelectedBtn" class="btn btn-danger" onclick="deleteSelected()" style="display: none;">üóëÔ∏è Delete Selected</button>
            </div>
            <table id="kaizenTable">
                <thead><tr><th><input type="checkbox" onchange="toggleSelectAll(this)"></th><th>ID</th><th>Date</th><th>Title</th><th>Employee</th><th>Project</th><th>Status</th><th>Benefit</th><th>Type</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
            <div class="table-controls">
                <div class="rows-per-page-selector">
                    <label for="rowsPerPage">Items per page:</label>
                    <select id="rowsPerPage" onchange="changeRowsPerPage(this.value)">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="all">All</option>
                    </select>
                </div>
                <div id="pagination-controls" class="pagination-controls"></div>
            </div>
        </div>
    </div>

    <div id="universalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // --- DATA STORAGE ---
        let kaizenData = [];
        const defaultKaizenData = [
             { "id": 1, "date": "2025-07-15", "title": "Kaizen Summary ‚Äì Automation for Picture Page in New Submission", "summary": "This Kaizen focuses on automating the process of creating formatted Word documents...", "status": "Implemented", "project": "LANE", "employee": "Priyank Vaghasiya (918)", "benefit": "Productivity", "reporting": "Internal", "comments": "", "reviewedBy": "", "kaizenType": "" },
             { "id": 2, "date": "2025-07-14", "title": "Centralized Automation Dashboard - Arroe", "summary": "Create a centralized Automation Dashboard to consolidate and visualize key MIS report metrics...", "status": "Implemented", "project": "AROE", "employee": "Ami Patel (689)", "benefit": "Both", "reporting": "Internal", "comments": "", "reviewedBy": "", "kaizenType": "" },
             // ... other default entries can be added here
        ];
        
        let filteredData = [];
        let charts = {};
        let currentPage = 1;
        let rowsPerPage = 10;

        // --- DATA PERSISTENCE ---
        function saveDataToLocalStorage() {
            localStorage.setItem('kaizenDashboardData', JSON.stringify(kaizenData));
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem('kaizenDashboardData');
            if (savedData && savedData.length > 2) { 
                kaizenData = JSON.parse(savedData);
            } else {
                kaizenData = defaultKaizenData;
                saveDataToLocalStorage();
            }
        }

        // --- UTILITY FUNCTIONS ---
        function formatDateMMDDYYYY(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
            const month = String(adjustedDate.getMonth() + 1).padStart(2, '0');
            const day = String(adjustedDate.getDate()).padStart(2, '0');
            const year = adjustedDate.getFullYear();
            return `${month}/${day}/${year}`;
        }

        function processAndAssignIds() {
            kaizenData.sort((a, b) => new Date(a.date) - new Date(b.date));
            kaizenData.forEach((item, index) => {
                item.id = index + 1;
            });
        }
        
        function excelSerialToDate(serial) {
            const utc_days = Math.floor(serial - 25569);
            const utc_value = utc_days * 86400;                                        
            const date_info = new Date(utc_value * 1000);
            return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate());
        }

        function parseAndValidateDate(dateValue) {
            if (!dateValue) return null;
            let date;
            if (typeof dateValue === 'number') {
                date = excelSerialToDate(dateValue);
            } else {
                date = new Date(dateValue);
            }
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
            return null;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        function initializeDashboard() {
            loadDataFromLocalStorage();
            processAndAssignIds();
            populateFilters(true);
            refreshDashboard();
        }
        function refreshDashboard() {
            applyFilters();
        }
        
        // --- IMPORT & EXPORT ---
        function triggerImport() { document.getElementById('importFile').click(); }

        async function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rawJsonData = XLSX.utils.sheet_to_json(worksheet);

                    const keyMap = { "date": "date", "kaizen idea title": "title", "title": "title", "kaizen idea summary": "summary", "summary": "summary", "implementation status": "status", "status": "status", "project name": "project", "project": "project", "employee name": "employee", "employee": "employee", "benefit": "benefit", "reporting": "reporting", "comments": "comments", "reviewed by": "reviewedBy", "kaizen type": "kaizenType" };
                    
                    const importedEntries = rawJsonData.map(rawRecord => {
                        const newRecord = {};
                        for (const excelHeader in rawRecord) {
                            const normalizedHeader = excelHeader.trim().toLowerCase();
                            const jsKey = keyMap[normalizedHeader];
                            if (jsKey) newRecord[jsKey] = rawRecord[excelHeader];
                        }
                        return newRecord;
                    });

                    let newRecordsAdded = 0, recordsOverwritten = 0, skippedRecords = 0;

                    for (const record of importedEntries) {
                        if (!record.title) {
                            skippedRecords++;
                            continue;
                        }
                        
                        let validDate = parseAndValidateDate(record.date);
                        if (!validDate) {
                            try {
                                const manualDate = await promptForDate(record);
                                record.date = manualDate;
                            } catch {
                                skippedRecords++;
                                continue;
                            }
                        } else {
                            record.date = validDate;
                        }

                        const existingIndex = kaizenData.findIndex(item => item.title && record.title && item.title.trim().toLowerCase() === record.title.trim().toLowerCase());
                        
                        if (existingIndex > -1) {
                            const originalId = kaizenData[existingIndex].id;
                            kaizenData[existingIndex] = { ...kaizenData[existingIndex], ...record, id: originalId };
                            recordsOverwritten++;
                        } else {
                            kaizenData.push(record);
                            newRecordsAdded++;
                        }
                    }

                    processAndAssignIds();
                    saveDataToLocalStorage();
                    
                    let alertMessage = `${newRecordsAdded} new records imported. ${recordsOverwritten} existing records overwritten.`;
                    if (skippedRecords > 0) alertMessage += `\n${skippedRecords} records were skipped.`;
                    alert(alertMessage);

                    event.target.value = ''; 
                    populateFilters(true);
                    refreshDashboard();

                } catch (error) { 
                    console.error("Error processing file:", error); 
                    alert("Failed to import file. Please ensure it's a valid Excel file with a header row.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportToExcel() {
            const worksheet = XLSX.utils.json_to_sheet(filteredData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "KaizenData");
            XLSX.writeFile(workbook, "kaizen_data_export.xlsx");
        }
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.autoTable({
                head: [['ID', 'Date', 'Title', 'Employee', 'Project', 'Status']],
                body: filteredData.map(item => [item.id, formatDateMMDDYYYY(item.date), item.title, item.employee, item.project, item.status]),
                startY: 10, theme: 'grid', headStyles: { fillColor: [102, 126, 234] }
            });
            doc.save('kaizen_data_export.pdf');
        }

        // --- FILTERING LOGIC ---
        function populateFilters(force = false) {
            if (!force && document.getElementById('yearFilter').options.length > 1) return;
            const unique = {
                year: [...new Set(kaizenData.map(item => new Date(item.date).getFullYear()))].sort((a, b) => b - a),
                status: [...new Set(kaizenData.map(item => item.status))].filter(Boolean).sort(),
                project: [...new Set(kaizenData.map(item => item.project))].filter(Boolean).sort(),
                employee: [...new Set(kaizenData.map(item => item.employee))].filter(Boolean).sort(),
                benefit: [...new Set(kaizenData.map(item => item.benefit))].filter(Boolean).sort(),
                kaizenType: [...new Set(kaizenData.map(item => item.kaizenType))].filter(Boolean).sort(),
                reporting: [...new Set(kaizenData.map(item => item.reporting))].filter(Boolean).sort(),
            };
            
            populateSelect('yearFilter', unique.year, "All Years");
            populateSelect('monthFilter', ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].map((m, i) => ({ value: i + 1, text: m })), "All Months");
            populateSelect('statusFilter', unique.status, "All Status");
            populateSelect('projectFilter', unique.project, "All Projects");
            populateSelect('employeeFilter', unique.employee, "All Employees");
            populateSelect('benefitFilter', unique.benefit, "All Benefits");
            populateSelect('typeFilter', unique.kaizenType, "All Types");
            populateSelect('reportingFilter', unique.reporting, "All");
        }

        function populateSelect(selectId, options, placeholder) {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="all">${placeholder}</option>`;
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = typeof option === 'object' ? option.value : option;
                opt.textContent = typeof option === 'object' ? option.text : option;
                select.appendChild(opt);
            });
        }

        function applyFilters() {
            const f = {
                term: document.getElementById('searchBox').value.toLowerCase(),
                year: document.getElementById('yearFilter').value,
                month: document.getElementById('monthFilter').value,
                status: document.getElementById('statusFilter').value,
                project: document.getElementById('projectFilter').value,
                employee: document.getElementById('employeeFilter').value,
                benefit: document.getElementById('benefitFilter').value,
                type: document.getElementById('typeFilter').value,
                reporting: document.getElementById('reportingFilter').value,
            };
            filteredData = kaizenData.filter(item => {
                const itemDate = new Date(item.date);
                const matchesSearch = f.term === '' || Object.values(item).some(val => String(val).toLowerCase().includes(f.term));
                return matchesSearch &&
                    (f.year === 'all' || itemDate.getFullYear() == f.year) &&
                    (f.month === 'all' || itemDate.getMonth() + 1 == f.month) &&
                    (f.status === 'all' || item.status === f.status) &&
                    (f.project === 'all' || item.project === f.project) &&
                    (f.employee === 'all' || item.employee === f.employee) &&
                    (f.benefit === 'all' || item.benefit === f.benefit) &&
                    (f.type === 'all' || item.kaizenType === f.type) &&
                    (f.reporting === 'all' || item.reporting === f.reporting);
            });
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            currentPage = 1;
            updateAllVisuals();
        }

        function clearFilters() {
            document.getElementById('searchBox').value = '';
            document.querySelectorAll('.filters-grid select').forEach(sel => sel.value = 'all');
            refreshDashboard();
        }

        // --- DASHBOARD UI UPDATES ---
        function updateAllVisuals() {
            updateMetrics();
            updateCharts();
            populateTable();
            setupPagination();
            updateDeleteSelectedButtonVisibility();
        }
        function updateMetrics() {
            const total = kaizenData.length;
            const implemented = kaizenData.filter(item => item.status === 'Implemented').length;
            const inProgress = kaizenData.filter(item => item.status === 'In Progress').length;
            const successRate = total > 0 ? Math.round((implemented / total) * 100) : 0;
            document.getElementById('totalKaizen').textContent = total;
            document.getElementById('implementedCount').textContent = implemented;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('successRate').textContent = `${successRate}%`;
        }
        function updateCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            createCharts();
        }

        function populateTable() {
            const tableBody = document.querySelector('#kaizenTable tbody');
            tableBody.innerHTML = '';
            
            const paginatedData = (rowsPerPage === 'all') 
                ? filteredData 
                : filteredData.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);

            if (paginatedData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">No data found.</td></tr>';
                return;
            }

            paginatedData.forEach(item => {
                const row = tableBody.insertRow();
                row.dataset.id = item.id;
                const statusClass = item.status === 'Implemented' ? 'status-implemented' : 'status-progress';
                const benefitClass = item.benefit === 'Productivity' ? 'benefit-productivity' : (item.benefit === 'Quality' ? 'benefit-quality' : 'benefit-both');
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" onchange="updateDeleteSelectedButtonVisibility()"></td>
                    <td>${item.id}</td> 
                    <td>${formatDateMMDDYYYY(item.date)}</td> 
                    <td>${item.title}</td> 
                    <td>${item.employee}</td> 
                    <td>${item.project}</td>
                    <td><span class="status-badge ${statusClass}">${item.status}</span></td>
                    <td><span class="benefit-badge ${benefitClass}">${item.benefit || '-'}</span></td>
                    <td>${item.kaizenType || '-'}</td>
                    <td>
                        <button class="action-btn" onclick="viewDetails(${item.id})">üëÅÔ∏è View</button>
                        <button class="action-btn" onclick="openEditModal(${item.id})">‚úèÔ∏è Edit</button>
                        <button class="action-btn" onclick="deleteItem(${item.id})">üóëÔ∏è Delete</button>
                    </td>`;
            });
            const selectAllCheckbox = document.querySelector('#kaizenTable thead th input[type="checkbox"]');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
        }
        
        function changeRowsPerPage(value) {
            rowsPerPage = (value === 'all') ? 'all' : parseInt(value);
            currentPage = 1;
            populateTable();
            setupPagination();
        }

        function setupPagination() {
            const controls = document.getElementById('pagination-controls');
            controls.innerHTML = '';
            if (rowsPerPage === 'all') return;

            const pageCount = Math.ceil(filteredData.length / rowsPerPage);
            if (pageCount <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '¬´ Prev';
            prevBtn.className = 'pagination-btn';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; populateTable(); setupPagination(); } };
            controls.appendChild(prevBtn);

            for (let i = 1; i <= pageCount; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                btn.onclick = () => { currentPage = i; populateTable(); setupPagination(); };
                controls.appendChild(btn);
            }

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next ¬ª';
            nextBtn.className = 'pagination-btn';
            nextBtn.disabled = currentPage === pageCount;
            nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; populateTable(); setupPagination(); } };
            controls.appendChild(nextBtn);
        }

        // --- CHART CREATION & INTERACTIVITY ---
        function createCharts() { createYearlyChart(); createMonthlyChart(); createStatusChart(); createBenefitChart(); }

        function handleChartClick(event, chart, filterType) {
            const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
            if (points.length) {
                const label = chart.data.labels[points[0].index];
                const filterSelect = document.getElementById(`${filterType}Filter`);
                filterSelect.value = filterSelect.value === label.toString() ? 'all' : label.toString();
                applyFilters();
            }
        }
        
        function createYearlyChart() {
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            const yearlyData = filteredData.reduce((acc, item) => {
                const year = new Date(item.date).getFullYear();
                acc[year] = (acc[year] || 0) + 1;
                return acc;
            }, {});
            const sortedYears = Object.keys(yearlyData).sort();
            const data = sortedYears.map(year => yearlyData[year]);
            const bgColor = 'rgba(118, 75, 162, 0.8)';

            charts.yearly = new Chart(ctx, { 
                type: 'bar', 
                data: { labels: sortedYears, datasets: [{ data, backgroundColor: bgColor, hoverBackgroundColor: bgColor, borderRadius: 5 }] }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, 
                    onClick: (e) => handleChartClick(e, charts.yearly, 'year'),
                    animation: {
                        onComplete: function() {
                            const ctx = this.ctx;
                            ctx.font = 'bold 12px Segoe UI';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            this.data.datasets.forEach((dataset, i) => {
                                const meta = this.getDatasetMeta(i);
                                meta.data.forEach((bar, index) => {
                                    const data = dataset.data[index];
                                    if (data > 0) {
                                        if (bar.y < 20) {
                                            ctx.fillStyle = 'white';
                                            ctx.fillText(data, bar.x, bar.y + 15);
                                        } else {
                                            ctx.fillStyle = '#444';
                                            ctx.fillText(data, bar.x, bar.y - 5);
                                        }
                                    }
                                });
                            });
                        }
                    }
                } 
            });
        }
        
        function createMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            const selectedYear = document.getElementById('yearFilter').value;
            const currentActualYear = new Date().getFullYear();

            let dataForChart;
            if (selectedYear === 'all') {
                dataForChart = kaizenData.filter(item => new Date(item.date).getFullYear() === currentActualYear);
            } else {
                dataForChart = filteredData;
            }

            const monthlyData = dataForChart.reduce((acc, item) => {
                const key = item.date.substring(0, 7);
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(m => new Date(m + '-02').toLocaleString('default', { month: 'short', year: '2-digit' }));
            const data = sortedMonths.map(m => monthlyData[m]);
            
            charts.monthly = new Chart(ctx, { 
                type: 'line', 
                data: { labels, datasets: [{ label: 'Kaizen Ideas', data, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', borderWidth: 3, fill: true, tension: 0.4 }] }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    animation: {
                        onComplete: function() {
                            const ctx = this.ctx;
                            ctx.font = 'bold 12px Segoe UI';
                            ctx.fillStyle = '#444';
                            ctx.textAlign = 'center';
                            this.data.datasets.forEach((dataset, i) => {
                                const meta = this.getDatasetMeta(i);
                                meta.data.forEach((point, index) => {
                                    const data = dataset.data[index];
                                    if (data > 0) {
                                       if(point.y < 20) {
                                            ctx.textBaseline = 'top';
                                            ctx.fillText(data, point.x, point.y + 8);
                                       } else {
                                            ctx.textBaseline = 'bottom';
                                            ctx.fillText(data, point.x, point.y - 8);
                                       }
                                    }
                                });
                            });
                        }
                    }
                } 
            });
        }
        
        function createStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const data = filteredData.reduce((acc, {status}) => { if(status) acc[status] = (acc[status]||0)+1; return acc; }, {});
            const bgColors = Object.keys(data).map(key => key === 'Implemented' ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)');

            charts.status = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: bgColors, hoverBackgroundColor: bgColors, borderWidth: 3, borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, onClick: (e) => handleChartClick(e, charts.status, 'status') } });
        }

        function createBenefitChart() {
            const ctx = document.getElementById('benefitChart').getContext('2d');
            const data = filteredData.reduce((acc, {benefit}) => { if(benefit) acc[benefit] = (acc[benefit] || 0)+1; return acc; }, {});
            const bgColors = ['rgba(118, 75, 162, 0.8)','rgba(54, 162, 235, 0.8)', 'rgba(255, 99, 132, 0.8)'];

            charts.benefit = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: bgColors, hoverBackgroundColor: bgColors, borderWidth: 2, borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, onClick: (e) => handleChartClick(e, charts.benefit, 'benefit') } });
        }

        // --- CRUD & MODAL ---
        function promptForDate(record) {
            return new Promise((resolve, reject) => {
                document.getElementById('modalTitle').textContent = `Date Required for: "${record.title}"`;
                document.getElementById('modalBody').innerHTML = `
                    <p>The date for this entry is missing or invalid. Please provide the correct date to continue.</p>
                    <div class="filter-group" style="margin: 20px 0;">
                        <label for="manual-date-input"><b>Date</b></label>
                        <input type="date" id="manual-date-input" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="skip-date-btn">Skip This Entry</button>
                        <button type="button" class="btn btn-success" id="save-date-btn">Save Date</button>
                    </div>`;
                document.getElementById('universalModal').style.display = 'block';

                document.getElementById('save-date-btn').onclick = () => {
                    const dateValue = document.getElementById('manual-date-input').value;
                    if (dateValue) {
                        closeModal();
                        resolve(dateValue);
                    } else {
                        alert("Please select a valid date.");
                    }
                };

                document.getElementById('skip-date-btn').onclick = () => {
                    closeModal();
                    reject(); 
                };
            });
        }

        function viewDetails(id) {
            const item = kaizenData.find(k => k.id === id);
            if (!item) return;
            document.getElementById('modalTitle').textContent = 'üìã Kaizen Details';
            document.getElementById('modalBody').innerHTML = `
                <div style="line-height: 1.8;">
                    <p><strong>ID:</strong> ${item.id}</p> <p><strong>Date:</strong> ${formatDateMMDDYYYY(item.date)}</p>
                    <p><strong>Title:</strong> ${item.title}</p> <p><strong>Summary:</strong> ${item.summary || '-'}</p>
                    <p><strong>Status:</strong> <span class="status-badge ${item.status === 'Implemented' ? 'status-implemented' : 'status-progress'}">${item.status}</span></p>
                    <p><strong>Project:</strong> ${item.project}</p> <p><strong>Employee:</strong> ${item.employee}</p>
                    <p><strong>Benefit:</strong> ${item.benefit || '-'}</p> <p><strong>Reporting:</strong> ${item.reporting || '-'}</p>
                    <p><strong>Comments:</strong> ${item.comments || '-'}</p> <p><strong>Reviewed By:</strong> ${item.reviewedBy || '-'}</p>
                    <p><strong>Kaizen Type:</strong> ${item.kaizenType || '-'}</p>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>`;
            document.getElementById('universalModal').style.display = 'block';
        }

        function createFormHTML(item = {}) {
            const isNew = !item.id;
            const statusOpts = ['Implemented', 'In Progress'].map(s => `<option value="${s}" ${item.status === s ? 'selected' : ''}>${s}</option>`).join('');
            const benefitOpts = ['Productivity', 'Quality', 'Both'].map(b => `<option value="${b}" ${item.benefit === b ? 'selected' : ''}>${b}</option>`).join('');
            const typeOpts = ['Unique', 'Improvised', ''].map(t => `<option value="${t}" ${item.kaizenType === t ? 'selected' : ''}>${t || 'N/A'}</option>`).join('');
            
            return `
                <form id="modalForm" class="modal-form" onsubmit="${isNew ? 'addNewKaizen(event)' : `saveChanges(${item.id}, event)`}">
                    <div class="filter-group full-width"><label>Title</label><input type="text" id="modal-title" value="${item.title || ''}" required></div>
                    <div class="filter-group full-width"><label>Summary</label><textarea id="modal-summary" rows="4">${item.summary || ''}</textarea></div>
                    <div class="filter-group"><label>Employee</label><input type="text" id="modal-employee" value="${item.employee || ''}"></div>
                    <div class="filter-group"><label>Project</label><input type="text" id="modal-project" value="${item.project || ''}"></div>
                    <div class="filter-group"><label>Date</label><input type="date" id="modal-date" value="${item.date || new Date().toISOString().split('T')[0]}" required></div>
                    <div class="filter-group"><label>Status</label><select id="modal-status">${statusOpts}</select></div>
                    <div class="filter-group"><label>Benefit</label><select id="modal-benefit">${benefitOpts}</select></div>
                    <div class="filter-group"><label>Kaizen Type</label><select id="modal-kaizenType">${typeOpts}</select></div>
                    <div class="filter-group"><label>Reviewed By</label><input type="text" id="modal-reviewedBy" value="${item.reviewedBy || ''}"></div>
                    <div class="filter-group"><label>Reporting</label><input type="text" id="modal-reporting" value="${item.reporting || ''}"></div>
                    <div class="filter-group full-width"><label>Comments</label><textarea id="modal-comments" rows="2">${item.comments || ''}</textarea></div>
                    <div class="modal-footer full-width">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Save Changes</button>
                    </div>
                </form>`;
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = '‚ûï Add New Kaizen';
            document.getElementById('modalBody').innerHTML = createFormHTML();
            document.getElementById('universalModal').style.display = 'block';
        }

        function addNewKaizen(event) {
            event.preventDefault();
            const newItem = {
                date: document.getElementById('modal-date').value,
                title: document.getElementById('modal-title').value,
                summary: document.getElementById('modal-summary').value,
                employee: document.getElementById('modal-employee').value,
                project: document.getElementById('modal-project').value,
                status: document.getElementById('modal-status').value,
                benefit: document.getElementById('modal-benefit').value,
                kaizenType: document.getElementById('modal-kaizenType').value,
                reviewedBy: document.getElementById('modal-reviewedBy').value,
                reporting: document.getElementById('modal-reporting').value,
                comments: document.getElementById('modal-comments').value,
            };
            kaizenData.push(newItem);
            processAndAssignIds();
            saveDataToLocalStorage();
            closeModal();
            populateFilters(true);
            refreshDashboard();
        }

        function openEditModal(id) {
            const item = kaizenData.find(k => k.id === id);
            if (!item) return;
            document.getElementById('modalTitle').textContent = `‚úèÔ∏è Edit Kaizen Entry #${id}`;
            document.getElementById('modalBody').innerHTML = createFormHTML(item);
            document.getElementById('universalModal').style.display = 'block';
        }

        function saveChanges(id, event) {
            event.preventDefault();
            const itemIndex = kaizenData.findIndex(k => k.id === id);
            if (itemIndex === -1) return;
            
            kaizenData[itemIndex] = {
                ...kaizenData[itemIndex],
                date: document.getElementById('modal-date').value,
                title: document.getElementById('modal-title').value,
                summary: document.getElementById('modal-summary').value,
                employee: document.getElementById('modal-employee').value,
                project: document.getElementById('modal-project').value,
                status: document.getElementById('modal-status').value,
                benefit: document.getElementById('modal-benefit').value,
                kaizenType: document.getElementById('modal-kaizenType').value,
                reviewedBy: document.getElementById('modal-reviewedBy').value,
                reporting: document.getElementById('modal-reporting').value,
                comments: document.getElementById('modal-comments').value,
            };

            processAndAssignIds();
            saveDataToLocalStorage();
            closeModal();
            populateFilters(true);
            refreshDashboard();
        }

        function deleteItem(id) {
            if (confirm(`Are you sure you want to delete Kaizen entry #${id}?`)) {
                kaizenData = kaizenData.filter(item => item.id !== id);
                processAndAssignIds();
                saveDataToLocalStorage();
                populateFilters(true);
                refreshDashboard();
            }
        }
        
        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) {
                alert("No items selected.");
                return;
            }
            if (confirm(`Are you sure you want to delete ${checkboxes.length} selected entries?`)) {
                const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.closest('tr').dataset.id));
                kaizenData = kaizenData.filter(item => !idsToDelete.includes(item.id));
                processAndAssignIds();
                saveDataToLocalStorage();
                populateFilters(true);
                refreshDashboard();
            }
        }

        function toggleSelectAll(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = masterCheckbox.checked);
            updateDeleteSelectedButtonVisibility();
        }

        function updateDeleteSelectedButtonVisibility() {
            const anyChecked = document.querySelectorAll('.row-checkbox:checked').length > 0;
            document.getElementById('deleteSelectedBtn').style.display = anyChecked ? 'inline-block' : 'none';
        }
        
        function closeModal() { document.getElementById('universalModal').style.display = 'none'; }
        window.onclick = function(event) { if (event.target == document.getElementById('universalModal')) { closeModal(); } }

    </script>
</body>
</html>